<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Identifica√ß√£o de Pimentas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0ea15c">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root {
      --green:#0ea366; --green-700:#0b7d4e; --bg:#f7fbf7; --ink:#12392b; --muted:#6b7b75;
      --card:#ffffff; --shadow:0 6px 24px rgba(0,0,0,.08), 0 3px 8px rgba(0,0,0,.05);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .container{max-width:980px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;padding:12px 0}
    header h1{font-size:22px;margin:0}
    .logo{width:36px;height:36px;border-radius:10px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    button{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
    .btn{background:var(--green);color:#fff;box-shadow:0 3px 0 var(--green-700)}
    .btn:active{transform:translateY(1px)}
    .btn-outline{background:#fff;color:var(--green);border:2px solid var(--green)}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .hide{display:none}
    .preview{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .preview img{width:100%;height:auto;border-radius:12px;box-shadow:var(--shadow);background:#f4f7f4}
    @media (max-width:820px){.preview{grid-template-columns:1fr}}
    .pill{font-size:12px;padding:5px 10px;border-radius:999px;background:#eaf6ee;color:#0d5836;display:inline-flex;align-items:center;gap:6px}
    .chip{background:#f0f3f2;border-radius:999px;padding:6px 10px;font-size:12px}

    /* Chat */
    .chat-wrap{position:fixed;inset:0;background:var(--bg);display:none;flex-direction:column}
    .chat-head{display:flex;align-items:center;gap:12px;padding:12px;background:#fff;box-shadow:var(--shadow)}
    .back{background:#f3f6f5;border-radius:10px;padding:6px 10px;cursor:pointer}
    .chat-body{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
    .me{align-self:flex-end;background:#dcf8c6;border-radius:16px 16px 4px 16px;padding:10px;max-width:85%}
    .bot{align-self:flex-start;background:#fff;border-radius:16px 16px 16px 4px;padding:10px;max-width:85%;box-shadow:var(--shadow)}
    .chat-foot{position:sticky;bottom:0;background:#fff;padding:8px;display:flex;gap:8px;align-items:center;box-shadow:var(--shadow)}
    .input{flex:1;border:1px solid #e1e6e4;border-radius:999px;padding:12px 14px}
    .kbd{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#f2f5f4;border-radius:999px;margin:3px 6px 0 0;font-size:12px;cursor:pointer}

    /* Splash overlay (1.8s) */
    .splash{
      position:fixed;inset:0;background:#f7fbf7 url('icons/splash.png') center/cover no-repeat;
      display:flex;align-items:center;justify-content:center;z-index:50;
      animation:fadeOut .4s ease 1.6s forwards; /* total ~1.8s */
    }
    @keyframes fadeOut{to{opacity:0;visibility:hidden}}
    .spinner{width:18px;height:18px;border:3px solid #fff;border-right-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

  <!-- Splash 1.8s -->
  <div id="splash" class="splash"></div>

  <div class="container">
    <header>
      <img src="icons/icon-192.png" alt="" class="logo">
      <h1>Identifica√ß√£o de Pimentas</h1>
    </header>

    <div class="grid">
      <section class="card">
        <div class="row">
          <input id="picker" type="file" accept="image/*" class="hide">
          <button class="btn-outline" id="btnFile">üìÅ Escolher imagem</button>
          <button class="btn-outline" id="btnCam">üì∑ Abrir c√¢mera</button>
          <button class="btn" id="btnDetect">üîé Identificar</button>
          <button class="btn" id="btnInfo">‚ÑπÔ∏è Mais informa√ß√µes</button>
        </div>
        <p class="muted">As imagens s√£o comprimidas para ~1024px antes do envio, para acelerar.</p>

        <div class="preview" id="preview">
          <div>
            <div class="chip">Original</div>
            <img id="imgOriginal" alt="">
          </div>
          <div>
            <div class="chip">Resultado</div>
            <img id="imgResult" alt="">
          </div>
        </div>

        <div id="tags" class="row" style="margin-top:10px"></div>
      </section>

      <aside class="card">
        <h3>Resumo</h3>
        <p id="summary" class="muted">Envie uma imagem para come√ßar.</p>
      </aside>
    </div>
  </div>

  <!-- Chat painel -->
  <div id="chat" class="chat-wrap">
    <div class="chat-head">
      <div class="back" id="back">‚Üê Voltar</div>
      <div>
        <div style="font-weight:700" id="chatTitle">Chat</div>
        <div class="muted" style="margin-top:2px">Digite 1‚Äì8 ou o nome da pimenta</div>
      </div>
    </div>
    <div id="chatBody" class="chat-body"></div>
    <div class="chat-foot">
      <input id="chatInput" class="input" placeholder="Digite a op√ß√£o (1‚Äì8) ou o nome da pimenta...">
      <button id="chatSend" class="btn">Enviar</button>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const API_BASE = '';   // sua API no Render
const DETECT_PATH = '/predict';
const PEPPER_INFO_URL = API_BASE + '/static/pepper_info.json';

/* ===== STATE ===== */
let fileBlob = null;
let lastLabel = null;
let pepperInfo = null;

/* ===== DOM ===== */
const picker = document.getElementById('picker');
const btnFile = document.getElementById('btnFile');
const btnCam  = document.getElementById('btnCam');
const btnDetect = document.getElementById('btnDetect');
const btnInfo = document.getElementById('btnInfo');
const imgOriginal = document.getElementById('imgOriginal');
const imgResult = document.getElementById('imgResult');
const summary = document.getElementById('summary');
const tags = document.getElementById('tags');

const chat = document.getElementById('chat');
const back = document.getElementById('back');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const chatTitle = document.getElementById('chatTitle');

/* ===== HELPERS ===== */
async function compressImage(file, maxSize=1024){
  const bitmap = await createImageBitmap(file);
  const scale = Math.min(1, maxSize/Math.max(bitmap.width, bitmap.height));
  const w = Math.round(bitmap.width*scale), h=Math.round(bitmap.height*scale);
  const canvas = Object.assign(document.createElement('canvas'), {width:w, height:h});
  const ctx = canvas.getContext('2d');
  ctx.drawImage(bitmap,0,0,w,h);
  return await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.9));
}
function pill(text){ const s=document.createElement('span'); s.className='pill'; s.textContent=text; return s; }
function bot(msg){ const d=document.createElement('div'); d.className='bot'; d.innerHTML = msg; chatBody.appendChild(d); chatBody.scrollTop=chatBody.scrollHeight; }
function me(msg){ const d=document.createElement('div'); d.className='me'; d.textContent=msg; chatBody.appendChild(d); chatBody.scrollTop=chatBody.scrollHeight; }
setTimeout(()=>document.getElementById('splash')?.remove(), 1900);

/* ===== EVENTOS UI ===== */
btnFile.onclick = ()=> picker.click();
btnCam.onclick = ()=>{
  picker.setAttribute('capture','environment'); // for√ßa c√¢mera em mobile
  picker.click();
};
picker.onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const blob = await compressImage(f, 1024);
  fileBlob = blob;
  imgOriginal.src = URL.createObjectURL(blob);
  imgResult.src = '';
  summary.textContent = 'Imagem pronta. Clique em Identificar.';
};

btnDetect.onclick = async ()=>{
  if(!fileBlob){ alert('Escolha uma imagem primeiro.'); return; }
  btnDetect.disabled = true; btnDetect.innerHTML = '<span class="spinner"></span>';

  const fd = new FormData();
  fd.append('file', fileBlob, 'pepper.jpg');

  try{
    const r = await fetch(API_BASE + DETECT_PATH, { method:'POST', body: fd });
    if(!r.ok){ throw new Error('Falha no servidor ('+r.status+')'); }
    const data = await r.json();

    // üîé Mapeia seu backend (main.py): top_pred.classe/conf, num_dets, image_b64/image_url
    const top   = data.top_pred || null;
    const label = top && (top.classe || top.class) ? (top.classe || top.class) : (data.label || '');
    const score = top && typeof top.conf === 'number' ? top.conf
                 : (typeof data.score === 'number' ? data.score : null);
    lastLabel   = label || null;

    // üñºÔ∏è Exibe anotada (aceita base64 ou URL relativa/absoluta)
    const ann = data.image_b64 || data.annotated || data.annotated_url || data.image_url || '';
    if (ann) {
      if (typeof ann === 'string' && ann.startsWith('data:image')) {
        imgResult.src = ann;
      } else {
        const url = (typeof ann === 'string') ? ann : '';
        imgResult.src = url.startsWith('http') ? url : (API_BASE + url);
      }
    } else {
      imgResult.removeAttribute('src');
    }

    // üè∑Ô∏è Tags/resumo
    tags.innerHTML = '';
    if(label) tags.appendChild(pill('üçΩÔ∏è ' + label));
    if(typeof score === 'number') tags.appendChild(pill('üéØ conf: ' + (score*100).toFixed(1) + '%'));
    if(typeof data.num_dets === 'number') tags.appendChild(pill('üì¶ caixas: ' + data.num_dets));

    summary.textContent = label
      ? `Prov√°vel pimenta: ${label}. Clique em ‚ÄúMais informa√ß√µes‚Äù para abrir o chat.`
      : (data.message || 'Nenhuma pimenta identificada.');
  }catch(err){
    console.error(err);
    alert('Erro: ' + err.message);
  }finally{
    btnDetect.disabled=false; btnDetect.textContent='üîé Identificar';
  }
};

btnInfo.onclick = async ()=>{
  if(!pepperInfo){
    try{ pepperInfo = await (await fetch(PEPPER_INFO_URL)).json(); }
    catch{ alert('N√£o consegui carregar as informa√ß√µes locais.'); return; }
  }
  openChat(lastLabel);
};

/* ===== CHAT ===== */
const MENU = `
üìå <b>pimenta</b> ‚Äî escolha uma op√ß√£o:<br>
1Ô∏è‚É£ O que √©<br>
2Ô∏è‚É£ Ard√™ncia (SHU)<br>
3Ô∏è‚É£ Usos/Receitas<br>
4Ô∏è‚É£ Conserva√ß√£o<br>
5Ô∏è‚É£ Substitui√ß√µes<br>
6Ô∏è‚É£ Origem<br>
7Ô∏è‚É£ Curiosidades/Extras<br>
8Ô∏è‚É£ Trocar pimenta<br><br>
üí° Voc√™ tamb√©m pode digitar o <b>nome/sin√¥nimo</b> da pimenta (ex.: jalape√±o/jalapeno, chilli, biquinho...).`;

function openChat(label){
  chat.style.display = 'flex';
  chatBody.innerHTML = '';
  const nome = label || 'pimenta';
  chatTitle.textContent = 'Chat: ' + nome;
  bot('Use os bot√µes ou digite. Respondo com base no arquivo local.');
  quickButtons();
  const k = normalizeKey(nome);
  const p = pepperInfo?.[k];
  if(p?.oque) bot(p.oque);
  else bot('Ainda n√£o tenho dados desta pimenta.');
}
back.onclick = ()=> chat.style.display='none';

function normalizeKey(s){
  if(!s) return '';
  s = s.toLowerCase()
       .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
       .replace(/[^a-z0-9]+/g,'');
  const map = {
    jalapeno:'jalapeno', jalapenopepper:'jalapeno', jalapenos:'jalapeno',
    habanero:'habanero',
    chilli:'chili', chili:'chili', pimenta_chilli:'chili',
    biquinho:'biquinho', fidalga:'fidalga', cambuci:'cambuci', bode:'bode',
    'scotchbonnet':'scotchbonnet', 'scotchbonnetpepper':'scotchbonnet'
  };
  if(map[s]) return map[s];
  return s;
}
function quickButtons(){
  const div = document.createElement('div');
  ['O que √©','Ard√™ncia (SHU)','Usos/receitas','Conserva√ß√£o','Substitui√ß√µes','Origem'].forEach((t,i)=>{
    const b = document.createElement('div'); b.className='kbd'; b.textContent = (i+1)+' '+t;
    b.onclick=()=>handleChatInput(String(i+1));
    div.appendChild(b);
  });
  chatBody.appendChild(div);
}
function replyFor(pepperKey, opt){
  const p = pepperInfo?.[pepperKey]; if(!p) return 'Ainda n√£o tenho dados desta pimenta.';
  switch(opt){
    case '1': return p.oque || 'Sem dados.';
    case '2': return p.shu  || 'Sem dados.';
    case '3': return (p.usos  || '') + (p.receitas? '<br><br>Receitas: '+p.receitas:'');
    case '4': return p.conservacao || 'Sem dados.';
    case '5': return p.substituicoes || 'Sem dados.';
    case '6': return p.origem || 'Sem dados.';
    case '7': return p.curiosidades || 'Sem dados.';
    default: return null;
  }
}
function handleChatInput(v){
  const txt = String(v||'').trim();
  if(!txt) return;
  me(txt);

  if(txt==='8'){ bot('Certo! Digite o <b>nome da pimenta</b> (ex.: jalape√±o, biquinho, chilli...).'); return; }

  if(/^[1-7]$/.test(txt)){
    const k = normalizeKey(lastLabel||'');
    const ans = replyFor(k, txt);
    bot(ans || 'N√£o encontrei resposta.');
    return;
  }

  const k = normalizeKey(txt);
  const p = pepperInfo?.[k];
  if(p){
    lastLabel = txt;
    chatTitle.textContent = 'Chat: ' + txt;
    bot(p.oque || 'Ok! Atualizei para essa pimenta.');
    quickButtons();
  }else{
    bot('N√£o entendi ü•≤. Responda com <b>1‚Äì8</b> ou digite o <b>nome/sin√¥nimo</b> da pimenta.');
    bot(MENU);
  }
  chatBody.scrollTop=chatBody.scrollHeight;
}
chatSend.onclick = ()=>{ const v = chatInput.value; chatInput.value=''; handleChatInput(v); };
chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ chatSend.click(); }});

/* ===== SW ===== */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(err=>console.log('SW fail:', err));
  });
}
</script>

</body>
</html>
